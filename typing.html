<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <style>
    body {
      text-align: center;
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
    }
    .word, .romaji, #result, #questionCounter {
      font-size: 20px;
      margin: 10px 0;
      display: none;
    }
    .romaji span {
      letter-spacing: 5px;
    }
    .correct {
      color: #007bff;
    }
    #waittime {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: auto;
      text-align: center;
      width: 500px;
      height: 110px;
      font-size: 18px;
      border: 2px solid black;
    }

    #gradeButtons {
      display: none;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      justify-content: center;
      max-width: 140px;
      margin: auto;
      margin-bottom: 20px;
    }
    #gradeButtons button {
      width: 140px;
      height: 45px;
      font-size: 18px;
      text-align: center;
      border: 2px solid black;
      background-color: #6ec6ff;
      color: black;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease-in-out;
    }

    #gradeButtons button:hover {
      background-color: #007bff;
      color: white;
      border-color: #0056b3;
    }

    #romajiDisplay {
      height: 65px;
      font-size: 18px;
      word-break: break-word;
      white-space: normal;
      max-width: 100%;
      display: none;
    }
    #wordContainer {
      background-color: #ffffff;
      height: 145px;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    #scoreDisplay {
      font-size: 30px;
      background-color: #ffffff;
      height: 140px;
      display: none;
      justify-content: center;
      text-align: center;
      align-items: center;
      border: 3px solid black;
      font-weight: bold;
    }
    #seisekiDisplay {
      font-size: 18px;
      background-color: #ffffff;
      height: 350px;
      display: none;
      justify-content: center;
      text-align: center;
      align-items: center;
      border: 3px solid black;
      flex-direction: column;
    }
    #seisekiContent {
      width: 520px;
      margin: 0 auto;
      text-align: left;
    }
    #seisekiContent table {
      width: 100%;
      border-collapse: collapse;
    }
    #seisekiContent td {
      padding: 5px 10px;
    }

    .seisekiTitle {
      font-size: 26px;
      font-weight: bold;
      color: black;
      width: 480px;
      background-color: #f8f9fa;
      padding: 10px 20px;
      display: inline-block;
      margin-bottom: 20px;
      text-align: center;
      text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    }

    .rankTable {
      margin: 0 auto;
      border-collapse: collapse;
    }

    .rankCell {
      padding: 10px;
      text-align: left;
      vertical-align: middle;
    }

    .rankCell img {
      width: auto;
      height: 100px;
    }
    .scoreTable .alignRight {
      text-align: right !important;
    }

    #kanjiDisplay {
      font-size: 25px;
      font-weight: bold;
      color: black;
      height: 85px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    #hiraganaDisplay {
      font-size: 20px;
      color: black;
      height: 60px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      text-align: center;
    }

    #keyboard {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
    }

    #keyboard .row {
      display: flex;
      gap: 5px;
    }

    #keyboard .key {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: bold;
      border: 1px solid black;
      border-radius: 3px;
      background-color: white;
      box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
      transition: background-color 0.2s, transform 0.1s;
    }

    #keyboard .key.home {
      border: 1px solid red;
    }

    #keyboard .key.active {
      background-color: #ff5722;
      transform: scale(1.1);
    }

    #keyboard .row:nth-child(2) {
      margin-left: 25px;
    }
    #keyboard .row:nth-child(3) {
      margin-left: 40px;
    }
    #keyboard .row:nth-child(4) {
      margin-left: 60px;
    }
    #handsContainer {
      display: block;
      justify-content: space-around;
      width: 400px;
      height: 60px;
      margin-top: -0;
      margin-left: 130px;
    }
    .finger {
      fill: lightgray;
      stroke: black;
      stroke-width: 2;
      transition: fill 0.2s;
    }

    .finger.active {
      fill: #ff5722;
    }

    #startimage {
      width: 450px;
      display: none;
      margin: auto;
    }
    #gradeDisplay {
      display: none;
      width: 100px;
      height: 30px;
      background-color: #696969;
      color: #fff;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      align-items: center;
      justify-content: center;
      position: fixed;
      bottom: 10px;
      left: 0px;
      z-index: 999;
    }

    #resetButton {
      display: none;
      width: 120px;
      height: 30px;
      background-color: #696969;
      color: white;
      text-align: center;
      font-size: 12px;
      font-weight: bold;
      line-height: 40px;
      border-radius: 10px;
      position: fixed;
      bottom: 10px;
      right: 5px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s;
    }

    #resetButton:hover {
      background-color: #505050;
    }

    .fixed-image-container {
      position: absolute;
      bottom: 10px;
      left: 10px;
      display: flex;
      align-items: flex-end;
      z-index: 1000;
    }

    .speech-bubble {
      position: relative;
      background: #ffffff;
      border: 2px solid black;
      padding: 8px 15px;
      border-radius: 15px;
      font-size: 14px;
      font-weight: bold;
      text-align: center;
      margin-left: 5px;
      margin-top: 15px;
      max-width: 550px;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    }

    .speech-bubble::after {
      content: "";
      position: absolute;
      top: 50%;
      left: -12px;
      transform: translateY(-50%);
      border-width: 8px;
      border-style: solid;
      border-color: transparent white transparent transparent;
      filter: drop-shadow(-2px 0px 0px black);
    }

    .demo-container {
      position: absolute;
      bottom: 145px;
      left: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 100px;
      background-color: white;
      border-radius: 10px;
      z-index: 1001;
    }

    .demo-area {
      font-size: 40px;
      font-weight: bold;
    }

    .demo-romaji {
      font-size: 20px;
      color: gray;
      margin-top: 5px;
    }

    .fixed-image {
      width: 120px;
      height: auto;
      transform: scaleX(-1);
    }

    .rankDisplay {
      font-size: 32px;
      font-weight: bold;
      text-align: center;
      padding: 10px;
      border-radius: 10px;
      display: inline-block;
      width: 400px;
      margin-top: 30px;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .rank-1 {
      background: linear-gradient(135deg, #ff6b6b, #ffb74d, #ffeb3b, #81c784, #64b5f6, #9575cd, #f48fb1);
      color: white;
      border: 5px solid #b39ddb;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .rank-2 {
      background: linear-gradient(135deg, #c79100, #ffb300, #ffd740, #ffb300, #c79100);
      color: white;
      border: 5px solid #ffe082;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
    }

    .rank-3 {
      background: linear-gradient(135deg, #757575, #bdbdbd, #e0e0e0, #bdbdbd, #757575);
      color: white;
      border: 5px solid #b0bec5;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
    }

    .rank-4 {
      background: linear-gradient(135deg, #8b4513, #d2691e, #a0522d, #d2691e, #8b4513);
      color: white;
      border: 5px solid #bc8f8f;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
    }

    .rank-5 {
      background: linear-gradient(135deg, #1565c0, #42a5f5, #90caf9, #42a5f5, #1565c0);
      color: white;
      border: 5px solid #64b5f6;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
    }

    .seisekiimagecontainer {
      position: absolute;
      bottom: 15px;
      right: 80px;
      transform: none;
      display: none;
      flex-direction: row;
      align-items: center;
      z-index: 10;
      width: 480px;
    }

    .seiseki-image {
      width: 100px;
      height: auto;
    }

    .seiseki-bubble {
      position: relative;
      background: #ffffff;
      border: 2px solid black;
      padding: 8px 15px;
      border-radius: 15px;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      margin-right: 5px;
      margin-top: 15px;
      max-width: 600px;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    }

    .seiseki-bubble::after {
      content: "";
      position: absolute;
      top: 50%;
      right: -12px;
      transform: translateY(-50%);
      border-width: 8px;
      border-style: solid;
      border-color: transparent transparent transparent white;
      filter: drop-shadow(2px 0px 0px black);
    }
    </style>
</head>
<body>
  <p id="select">ã©ã®ãŒãã­ã‚“ã®ã€€ã‚‚ã‚“ã ã„ã«ã€€ã¡ã‚‡ã†ã›ã‚“ã™ã‚‹ï¼Ÿ</p>
  <div id="waittime">ã‚ˆã¿ã“ã¿ã¡ã‚…ã†â€¦âŒ›ã¡ã‚‡ã£ã¨ã¾ã£ã¦ã­</div>
  <div id="gradeButtons">
    <button class="gradeButton" data-grade="1">ï¼‘ã­ã‚“ã›ã„</button>
    <button class="gradeButton" data-grade="2">ï¼’å¹´ç”Ÿ</button>
    <button class="gradeButton" data-grade="3">ï¼“å¹´ç”Ÿ</button>
    <button class="gradeButton" data-grade="4">ï¼”å¹´ç”Ÿ</button>
    <button class="gradeButton" data-grade="5">ï¼•å¹´ç”Ÿ</button>
    <button class="gradeButton" data-grade="6">ï¼–å¹´ç”Ÿ</button>
  </div>
  <p id="startMessage" style="display: none; font-size: 18px; margin-top: 30px;">ã˜ã‚…ã‚“ã³ã¯ã„ã„ã‹ãªï¼Ÿ<BR>ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§ã¯ã˜ã‚ã‚‹ã‚ˆ</p>
  <img id="startimage" src="key.png" alt="å¾…æ©Ÿä¸­">
  <div id="wordContainer">
    <div id="kanjiDisplay"></div>
    <div id="hiraganaDisplay"></div>
  </div>
  <div id="scoreDisplay">
    <p>ã—ã‚…ã†ã‚Šã‚‡ã†ï¼</p>
  </div>
  <div id="seisekiDisplay">
    <p class="seisekiTitle">ã›ã„ã›ãã¯ã£ã´ã‚‡ã†</p>
    <p id="seisekiContent"></p>
    <div id="nankyu"></div>
  </div>
  <p class="romaji" id="romajiDisplay"></p>
  <div id="keyboard" class="keyboard">
    <div class="row">
      <div class="key" id="key1">1</div>
      <div class="key" id="key2">2</div>
      <div class="key" id="key3">3</div>
      <div class="key" id="key4">4</div>
      <div class="key" id="key5">5</div>
      <div class="key" id="key6">6</div>
      <div class="key" id="key7">7</div>
      <div class="key" id="key8">8</div>
      <div class="key" id="key9">9</div>
      <div class="key" id="key0">0</div>
      <div class="key" id="key-">-</div>
    </div>
    <div class="row">
      <div class="key" id="keyQ">Q</div>
      <div class="key" id="keyW">W</div>
      <div class="key" id="keyE">E</div>
      <div class="key" id="keyR">R</div>
      <div class="key" id="keyT">T</div>
      <div class="key" id="keyY">Y</div>
      <div class="key" id="keyU">U</div>
      <div class="key" id="keyI">I</div>
      <div class="key" id="keyO">O</div>
      <div class="key" id="keyP">P</div>
      <div class="key" id="key@">@</div>
    </div>
    <div class="row">
      <div class="key home" id="keyA">A</div>
      <div class="key home" id="keyS">S</div>
      <div class="key home" id="keyD">D</div>
      <div class="key home" id="keyF">F</div>
      <div class="key" id="keyG">G</div>
      <div class="key" id="keyH">H</div>
      <div class="key home" id="keyJ">J</div>
      <div class="key home" id="keyK">K</div>
      <div class="key home" id="keyL">L</div>
      <div class="key home" id="keySemicolon">;</div>
      <div class="key" id="keycolon">:</div>
    </div>
    <div class="row">
      <div class="key" id="keyZ">Z</div>
      <div class="key" id="keyX">X</div>
      <div class="key" id="keyC">C</div>
      <div class="key" id="keyV">V</div>
      <div class="key" id="keyB">B</div>
      <div class="key" id="keyN">N</div>
      <div class="key" id="keyM">M</div>
      <div class="key" id="key,">,</div>
      <div class="key" id="key.">.</div>
      <div class="key" id="key/">/</div>
      <div class="key" id="key\">\</div>
    </div>
  </div>
  <div id="handsContainer">
    <svg id="hands" viewBox="0 0 450 60" width="450" height="65">
      <!-- å·¦æ‰‹ -->
      <g id="leftHand" transform="translate(45, -10)">
        <rect class="finger" id="finger-L5" x="-20" y="50" width="27" height="35" rx="13" ry="13" stroke="black" stroke-width="2"/>
        <rect class="finger" id="finger-L4" x="16" y="35" width="27" height="50" rx="13" ry="13" stroke="black" stroke-width="2"/>
        <rect class="finger" id="finger-L3" x="52" y="25" width="27" height="60" rx="13" ry="13" stroke="black" stroke-width="2"/>
        <rect class="finger" id="finger-L2" x="89" y="45" width="27" height="40" rx="13" ry="13" stroke="black" stroke-width="2"/>
        <rect class="finger" id="finger-L1" x="124" y="63" width="27" height="25" rx="13" ry="13" stroke="black" stroke-width="2"/>
      </g>

      <g id="rightHand" transform="translate(355, -10) scale(-1, 1)">
        <rect class="finger" id="finger-R5" x="-20" y="50" width="27" height="35" rx="13" ry="13" stroke="black" stroke-width="2"/>
        <rect class="finger" id="finger-R4" x="16" y="35" width="27" height="50" rx="13" ry="13" stroke="black" stroke-width="2"/>
        <rect class="finger" id="finger-R3" x="52" y="25" width="27" height="60" rx="13" ry="13" stroke="black" stroke-width="2"/>
        <rect class="finger" id="finger-R2" x="89" y="45" width="27" height="40" rx="13" ry="13" stroke="black" stroke-width="2"/>
        <rect class="finger" id="finger-R1" x="124" y="63" width="27" height="25" rx="13" ry="13" stroke="black" stroke-width="2"/>
      </g>

    </svg>

  </div>
  <div id="gradeDisplay"></div>
  <div id="resetButton">ã•ã„ã—ã‚‡ã«ã‚‚ã©ã‚‹</div>
  <p id="result"></p>

  <div class="fixed-image-container" id="fixedimage">
    <div class="demo-container">
      <div class="demo-area"></div>
      <div class="demo-romaji"></div>
    </div>
    <img src="taiken1.png" class="fixed-image">
    <div class="speech-bubble">ã¤ã‹ã†ã‚†ã³ã¨ã€€ã‚­ãƒ¼ãŒã²ã‹ã‚‹ã‚ˆã€€ãŒã‚ã‚“ã‚’ã¿ãªãŒã‚‰ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã¦ã¿ã‚ˆã†</div>
  </div>
  <div class="seisekiimagecontainer" id="seisekiimage">
    <div class="seiseki-bubble"></div>
    <img src="taiken2.png" class="seiseki-image">
  </div>


    <script>
  let questionsData = {};
  let questions = []; //å•é¡Œãƒªã‚¹ãƒˆ
  let remainingQuestions = []; //ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œç”¨
  let currentQuestion = {}; //ç¾åœ¨ã®å•é¡Œ
  let currentIndex = 0;
  let questionCount = 0; //å‡ºé¡Œã‚«ã‚¦ãƒ³ãƒˆ
  let currentAnswerList = []; //ç¾åœ¨ã®å›ç­”ãƒªã‚¹ãƒˆ
  const maxQuestions = 6; //å‡ºé¡Œã™ã‚‹å•é¡Œæ•°
  let currentDisplayedRomaji = ""; //ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒ­ãƒ¼ãƒå­—ã‚’ä¿æŒ
  let totalKeysPressed = 0;  //æŠ¼ã•ã‚ŒãŸã‚­ãƒ¼ã®ç·æ•°
  let correctKeysPressed = 0; //æ­£ã—ãæ‰“ã£ãŸã‚­ãƒ¼ã®æ•°
  let mistakeCount = 0;  //ãƒŸã‚¹ã—ãŸã‚­ãƒ¼ã®æ•°
  let startTime = 0;  //ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚é–“
  let endTime = 0;  //ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚é–“
  let selectedGrade = 1; //ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§1å¹´ç”Ÿ
  let previousWordEndedWithN = 0; //nç‰¹æ®Šå‡¦ç†ç”¨
  let previousWordEndedWithN2 = 0; //nç‰¹æ®Šå‡¦ç†ç”¨
        
        // ã²ã‚‰ãŒãª â†’ ãƒ­ãƒ¼ãƒå­—å¤‰æ›è¡¨
        // åŸºæœ¬ã®ã€Œã²ã‚‰ãŒãª â†’ ãƒ­ãƒ¼ãƒå­—ã€ãƒãƒƒãƒ”ãƒ³ã‚°
        const hiraToRoma = {
            "ã‚": ["a"], "ã„": ["i"], "ã†": ["u"], "ãˆ": ["e"], "ãŠ": ["o"],
            "ã‹": ["ka"], "ã": ["ki"], "ã": ["ku"], "ã‘": ["ke"], "ã“": ["ko"],
            "ã•": ["sa"], "ã—": ["si", "shi"], "ã™": ["su"], "ã›": ["se"], "ã": ["so"],
            "ãŸ": ["ta"], "ã¡": ["ti", "chi"], "ã¤": ["tu", "tsu"], "ã¦": ["te"], "ã¨": ["to"],
            "ãª": ["na"], "ã«": ["ni"], "ã¬": ["nu"], "ã­": ["ne"], "ã®": ["no"],
            "ã¯": ["ha"], "ã²": ["hi"], "ãµ": ["hu", "fu"], "ã¸": ["he"], "ã»": ["ho"],
            "ã¾": ["ma"], "ã¿": ["mi"], "ã‚€": ["mu"], "ã‚": ["me"], "ã‚‚": ["mo"],
            "ã‚„": ["ya"], "ã‚†": ["yu"], "ã‚ˆ": ["yo"],
            "ã‚‰": ["ra"], "ã‚Š": ["ri"], "ã‚‹": ["ru"], "ã‚Œ": ["re"], "ã‚": ["ro"],
            "ã‚": ["wa"], "ã‚’": ["wo"], "ã‚“": ["n", "nn"],

            // æ¿éŸ³
            "ãŒ": ["ga"], "ã": ["gi"], "ã": ["gu"], "ã’": ["ge"], "ã”": ["go"],
            "ã–": ["za"], "ã˜": ["ji", "zi"], "ãš": ["zu"], "ãœ": ["ze"], "ã": ["zo"],
            "ã ": ["da"], "ã¢": ["di"], "ã¥": ["du"], "ã§": ["de"], "ã©": ["do"],
            "ã°": ["ba"], "ã³": ["bi"], "ã¶": ["bu"], "ã¹": ["be"], "ã¼": ["bo"],
            "ã±": ["pa"], "ã´": ["pi"], "ã·": ["pu"], "ãº": ["pe"], "ã½": ["po"],

            // å°ã•ã„ã€Œã£ã€
            "ã£": ["ltu", "xtu"],

            // **æ•°å­—ã®å¯¾å¿œã‚’è¿½åŠ **
            "ï¼": ["0"], "ï¼‘": ["1"], "ï¼’": ["2"], "ï¼“": ["3"], "ï¼”": ["4"],
            "ï¼•": ["5"], "ï¼–": ["6"], "ï¼—": ["7"], "ï¼˜": ["8"], "ï¼™": ["9"],

            // é•·éŸ³ï¼ˆãƒ¼ï¼‰ã¯ã€Œ-ã€ã®ã¿ã«ã™ã‚‹
            "ãƒ¼": ["-"], "ã€‚": ["."], "ã€": [","],

            // **ã€Œã‚ƒã‚…ã‚‡ã€ã®å¤‰æ›ã‚’çµ±åˆ**
            "ãã‚ƒ": ["kya"], "ãã‚…": ["kyu"], "ãã‚‡": ["kyo"],
            "ã—ã‚ƒ": ["sya", "sha", "silya"], "ã—ã‚…": ["syu", "shu", "silyu"], "ã—ã‚‡": ["syo", "sho", "silyo"],
            "ã¡ã‚ƒ": ["tya", "cha"], "ã¡ã‚…": ["tyu", "chu"], "ã¡ã‚‡": ["tyo", "cho"],
            "ã«ã‚ƒ": ["nya"], "ã«ã‚…": ["nyu"], "ã«ã‚‡": ["nyo"],
            "ã²ã‚ƒ": ["hya"], "ã²ã‚…": ["hyu"], "ã²ã‚‡": ["hyo"],
            "ã¿ã‚ƒ": ["mya"], "ã¿ã‚…": ["myu"], "ã¿ã‚‡": ["myo"],
            "ã‚Šã‚ƒ": ["rya"], "ã‚Šã‚…": ["ryu"], "ã‚Šã‚‡": ["ryo"],
            "ãã‚ƒ": ["gya"], "ãã‚…": ["gyu"], "ãã‚‡": ["gyo"],
            "ã˜ã‚ƒ": ["zya", "ja"], "ã˜ã‚…": ["zyu", "ju"], "ã˜ã‚‡": ["zyo", "jo"],
            "ã³ã‚ƒ": ["bya"], "ã³ã‚…": ["byu"], "ã³ã‚‡": ["byo"],
            "ã´ã‚ƒ": ["pya"], "ã´ã‚…": ["pyu"], "ã´ã‚‡": ["pyo"],
            "ã¦ãƒ": ["thi"], "ã§ãƒ": ["dhi"], "ã§ã‚…": ["dhu"],
            "ãµã": ["fa"], "ãµãƒ": ["fi"], "ãµã‚…": ["fyu"], "ãµã‡": ["fe"], "ãµã‰": ["fo"],

            // å°æ›¸ãã€Œã‚ƒã‚…ã‚‡ã€ã‚’çµ±åˆï¼ˆã€Œlyaã€ã€Œxyaã€å¯¾å¿œï¼‰
            "ã‚ƒ": ["ya", "lya", "xya"], "ã‚…": ["yu", "lyu", "xyu"], "ã‚‡": ["yo", "lyo", "xyo"]
        };

        const keyToFinger = {
            "1": "L5", "2": "L5", "Q": "L5", "A": "L5", "Z": "L5",
            "3": "L4", "W": "L4", "S": "L4", "X": "L4",
            "4": "L3", "E": "L3", "D": "L3", "C": "L3",
            "5": "L2", "R": "L2", "F": "L2", "V": "L2", "T": "L2", "G": "L2", "B": "L2",
            " ": "L1", // ã‚¹ãƒšãƒ¼ã‚¹ãƒãƒ¼

            "6": "R2", "Y": "R2", "H": "R2", "N": "R2", "7": "R2", "U": "R2", "J": "R2", "M": "R2",
            "8": "R3", "I": "R3", "K": "R3", ",": "R3",
            "9": "R4", "O": "R4", "L": "R4", ".": "R4",
            "0": "R5", "P": "R5", ";": "R5", "/": "R5", "-": "R5", "@": "R5"
        };

          // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®ãƒ‡ãƒ¢éƒ¨åˆ†
          const demoChars = ["ã‚", "ã„", "ã†", "ãˆ", "ãŠ"];
          let demoIndex = 0;
          let demoInterval;
          let demoArea;
          let demoRomaji;

function startTypingDemo() {
    demoIndex = 0;
    demoInterval = setInterval(() => {
        stopTypingDemo();

        const currentChar = demoChars[demoIndex];
        const romajiList = hiraToRoma[currentChar];
        const romaji = romajiList ? romajiList[0] : "";

        demoArea.textContent = currentChar;
        demoRomaji.textContent = romaji.toUpperCase();

        if (romaji) {
            const keyElement = document.getElementById(`key${romaji.toUpperCase()}`);
            const fingerId = keyToFinger[romaji.toUpperCase()];
            const fingerElement = document.getElementById(`finger-${fingerId}`);

            if (keyElement) keyElement.classList.add("active");
            if (fingerElement) fingerElement.classList.add("active");
        }

        demoIndex = (demoIndex + 1) % demoChars.length;
    }, 2000);
  }

//ãƒ‡ãƒ¢ã‚’åœæ­¢
  function stopTypingDemo() {
    document.querySelectorAll(".key.active").forEach(el => el.classList.remove("active"));
    document.querySelectorAll(".finger.active").forEach(el => el.classList.remove("active"));
    demoArea.textContent = "";
    demoRomaji.textContent = "";
  }
    document.addEventListener("DOMContentLoaded", async function () {
    demoArea = document.querySelector(".demo-area");
    demoRomaji = document.querySelector(".demo-romaji");
    const gradeButtons = document.querySelectorAll(".gradeButton");

    if (!demoArea || !demoRomaji) return;

    await loadAllQuestions();

    // âœ… ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã§å­¦å¹´ã‚’é¸æŠã—ã¦ã‚²ãƒ¼ãƒ ã¸
    gradeButtons.forEach(button => {
      button.addEventListener("click", function () {
        selectedGrade = `å•é¡Œ${this.getAttribute("data-grade")}å¹´ç”Ÿ`;

        clearInterval(demoInterval);
        stopTypingDemo();

        if (questionsData[selectedGrade]) {
          questions = [...questionsData[selectedGrade]];
          remainingQuestions = [...questions];
        } else {
          console.error("ã‚¨ãƒ©ãƒ¼: å­¦å¹´ã®å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼");
          return;
        }

        document.getElementById("gradeButtons").style.display = "none";
        document.getElementById("select").style.display = "none";
        document.getElementById("keyboard").style.display = "none";
        document.getElementById("fixedimage").style.display = "none";
        document.getElementById("handsContainer").style.display = "none";
        document.getElementById("startimage").style.display = "block";
        document.getElementById("startMessage").style.display = "block";

        document.addEventListener("keydown", startOnKeyPress);
      });
    });

    startTypingDemo(); // ãƒ‡ãƒ¢é–‹å§‹
  });

// âœ… è¤‡æ•°JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ questionsData ã«ã¾ã¨ã‚ã‚‹
  async function loadAllQuestions() {
    const grades = [1, 2, 3, 4, 5, 6];
    for (const grade of grades) {
      const fileName = `questions_${grade}.json`;
      try {
        const response = await fetch(fileName);
        const data = await response.json();
        questionsData[`å•é¡Œ${grade}å¹´ç”Ÿ`] = data;
      } catch (error) {
        console.error(`${fileName} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:`, error);
      }
    }

    // èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    document.getElementById("waittime").style.display = "none";
    document.getElementById("gradeButtons").style.display = "grid";
  }

function startOnKeyPress(event) {
      if (event.key === "Enter") {
        document.getElementById("startimage").style.display = "none";
        document.getElementById("startMessage").style.display = "none";
        document.removeEventListener("keydown", startOnKeyPress);
        startGame();
      }
    }

  //ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
  async function startGame() {
    document.getElementById("gradeDisplay").style.display = "flex";
    document.getElementById("gradeDisplay").textContent = selectedGrade.substring(2);
    document.getElementById("resetButton").style.display = "flex";
    document.getElementById("keyboard").style.display = "flex";
    document.getElementById("wordContainer").style.display = "flex";
    document.getElementById("romajiDisplay").style.display = "block";
    document.getElementById("handsContainer").style.display = "block";
    document.getElementById("result").style.display = "block";

    //ã‚¹ã‚³ã‚¢è¨ˆç®—ã®ãŸã‚ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
    totalKeysPressed = 0;
    correctKeysPressed = 0;
    mistakeCount = 0;
    startTime = Date.now();

    remainingQuestions = [...questions];
    document.addEventListener("keydown", handleTypingKeyPress);

    setRandomQuestion();
  }

  function setRandomQuestion() {
    if (questionCount >= maxQuestions || remainingQuestions.length === 0) {
      endTime = Date.now();
      document.removeEventListener("keydown", handleTypingKeyPress);
      showScoreScreen();
      return;
    }
    //nç‰¹åˆ¥å‡¦ç†
    if (currentDisplayedRomaji && currentDisplayedRomaji.endsWith("n")) {
      previousWordEndedWithN = 1;
    } else {
      previousWordEndedWithN = 0;
    }
    currentIndex = 0;
    let randomIndex = Math.floor(Math.random() * remainingQuestions.length);
    currentQuestion = remainingQuestions[randomIndex];
    remainingQuestions.splice(randomIndex, 1);
    questionCount++;

    if (!currentQuestion.hiragana) {
      console.error("ã‚¨ãƒ©ãƒ¼: hiragana ã®å€¤ãŒ undefined ã§ã™", currentQuestion);
      return;
    }

    currentAnswerList = convertToRomaji(currentQuestion.hiragana);

    if (currentAnswerList.length > 0) {
      currentDisplayedRomaji = currentAnswerList[0];
    } else {
      console.error("ã‚¨ãƒ©ãƒ¼: ãƒ­ãƒ¼ãƒå­—å¤‰æ›çµæœãŒç©ºã§ã™", currentQuestion.hiragana);
      return;
    }

    //å•é¡Œæ–‡è¡¨ç¤º
    document.getElementById("kanjiDisplay").innerHTML = `<span>${currentQuestion.kanji}</span>`;
    document.getElementById("hiraganaDisplay").innerHTML = `<span>${currentQuestion.hiragana}</span>`;

    document.getElementById("romajiDisplay").innerHTML = currentAnswerList[0]
      .split("")
      .map(letter => `<span>${letter.toUpperCase()}</span>`)
      .join("");

    document.getElementById("result").textContent = "";

    highlightNextKey(); 
  }

  //ã²ã‚‰ãŒãªâ†’ãƒ­ãƒ¼ãƒå­—å¤‰æ›
  function convertToRomaji(hiragana) {
    let romajiList = [""];

    for (let i = 0; i < hiragana.length; i++) {
      const char = hiragana[i];

      //ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
      if (!hiraToRoma[char]) {
        console.warn("å¤‰æ›ã§ããªã„æ–‡å­—:", char);
        continue;
      }

      let newRomajiList = [];

      //ã€Œã—ã‚…ã€ã€Œã—ã‚ƒã€ã€Œã—ã‚‡ã€ãªã©ã®2æ–‡å­—ã‚’æœ€åˆã«å‡¦ç†
      if (i < hiragana.length - 1) {
        let combinedChar = char + hiragana[i + 1];
        if (hiraToRoma[combinedChar]) {
          let sortedVariants = [...hiraToRoma[combinedChar]];
          sortedVariants.sort((a, b) => a.length - b.length);

          for (const prefix of romajiList) {
            for (const variant of sortedVariants) {
              newRomajiList.push(prefix + variant);
            }
          }
          romajiList = newRomajiList;
          i++;
          continue;
        }
      }

      //ã€Œã£ã€ã®å‡¦ç†
      if (char === "ã£") {
        let sortedVariants = [];

        //æ¬¡ã®æ–‡å­—ãŒå­éŸ³ãªã‚‰å­éŸ³ã‚’é‡ã­ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å„ªå…ˆ
        if (i + 1 < hiragana.length) {
          let nextChar = hiraToRoma[hiragana[i + 1]];
          if (nextChar) {
            let consonant = nextChar[0].charAt(0);
            if (consonant.match(/[bcdfghjklmnpqrstvwxyz]/)) {
              sortedVariants.push(consonant); // å­éŸ³ã‚’é‡ã­ã‚‹
            }
          }
        }

        // ã€Œltuã€ã€Œxtuã€ã‚’å¾Œå›ã—ã«ã™ã‚‹
        sortedVariants.push(...hiraToRoma["ã£"]);

        for (const prefix of romajiList) {
          for (const variant of sortedVariants) {
            newRomajiList.push(prefix + variant);
          }
        }

        romajiList = newRomajiList;
        continue;
      }

      //ã²ã‚‰ãŒãªã‚’ãƒ­ãƒ¼ãƒå­—ã«å¤‰æ›
      let sortedVariants = [...hiraToRoma[char]];
      sortedVariants.sort((a, b) => a.length - b.length); //çŸ­ã„ã‚‚ã®ã‚’å„ªå…ˆ

      for (const prefix of romajiList) {
        for (const variant of sortedVariants) {
          newRomajiList.push(prefix + variant);
        }
      }
      romajiList = newRomajiList;
    }

    return romajiList;
  }

  function highlightNextKey() {
    //ã‚­ãƒ¼ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
    const previousKey = document.querySelector(".key.active");
    if (previousKey) {
      previousKey.classList.remove("active");
    }

    //æ¬¡ã«æŠ¼ã™ã‚­ãƒ¼ã‚’å–å¾—
    const nextKey = currentDisplayedRomaji[currentIndex];
    if (!nextKey) {
      console.warn("æ¬¡ã®ã‚­ãƒ¼ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ:", currentDisplayedRomaji, currentIndex); // **ãƒ‡ãƒãƒƒã‚°**
      return;
    }

    //ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    const keyElement = document.getElementById(`key${nextKey.toUpperCase()}`);
    if (keyElement) {
      keyElement.classList.add("active");
    }
    highlightFinger(nextKey);
  }

  function highlightFinger(key) {
    const fingerId = keyToFinger[key.toUpperCase()];
    if (!fingerId) return;

    //ã™ã¹ã¦ã®æŒ‡ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
    document.querySelectorAll(".finger").forEach(finger => {
      finger.classList.remove("active");
    });

    //æŠ¼ã•ã‚ŒãŸã‚­ãƒ¼ã«å¯¾å¿œã™ã‚‹æŒ‡ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    const fingerElement = document.getElementById(`finger-${fingerId}`);

    if (fingerElement) {
      fingerElement.classList.add("active");
    }
  }

function handleTypingKeyPress(event) {
    if (!currentAnswerList || currentAnswerList.length === 0) return;
    if (currentIndex >= Math.max(...currentAnswerList.map(answer => answer.length))) return;

    const key = event.key.toLowerCase();
    totalKeysPressed++;
    let newAnswerList = [];
    let matched = false;

    //nç‰¹åˆ¥å‡¦ç†
    if (previousWordEndedWithN === 1 && currentIndex === 0 && key === "n") {
      //æ¬¡ã®å•é¡Œã®æœ€åˆã®ã²ã‚‰ãŒãªã‚’å–å¾—
      if (!currentQuestion || !currentQuestion.hiragana) {
        console.error("âŒ ã‚¨ãƒ©ãƒ¼: currentQuestion.hiragana ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼");
        return;
      }

      const nextFirstHiragana = currentQuestion.hiragana.charAt(0);

      if ("ãªã«ã¬ã­ã®ã«ã‚ƒã«ã‚…ã«ã‚‡".includes(nextFirstHiragana) && previousWordEndedWithN2 === 0) {
        correctKeysPressed++;
        previousWordEndedWithN2 = 1;
        currentDisplayedRomaji = currentAnswerList[0];

        let spans = document.getElementById("romajiDisplay").getElementsByTagName("span");

        if (spans[currentIndex]) {
            spans[currentIndex].classList.add("correct");
        }

        currentIndex++;

        highlightNextKey();

        document.getElementById("romajiDisplay").innerHTML = currentDisplayedRomaji
            .split("")
            .map((letter, index) => `<span class="${index < currentIndex ? 'correct' : ''}">${letter.toUpperCase()}</span>`)
            .join("");
        return;
      } else {
        correctKeysPressed++;
        previousWordEndedWithN = 0;
        previousWordEndedWithN2 = 0;
        return;
      }
    } else {
      if (previousWordEndedWithN === 1 && key === "n") {
        correctKeysPressed++;
        previousWordEndedWithN = 0;
        previousWordEndedWithN2 = 0;
        return;
      }
      previousWordEndedWithN = 0;
      previousWordEndedWithN2 = 0;
    }

    for (let option of currentAnswerList) {
        if (option.startsWith(option.substring(0, currentIndex) + key)) {
            newAnswerList.push(option);
            matched = true;
        }
    }

    if (matched) {
        correctKeysPressed++;
        currentAnswerList = newAnswerList;
        currentDisplayedRomaji = newAnswerList[0];

        let spans = document.getElementById("romajiDisplay").getElementsByTagName("span");

        if (spans[currentIndex]) {
            spans[currentIndex].classList.add("correct");
        }

        currentIndex++;

        highlightNextKey();

        //è¡¨ç¤ºã‚’æ›´æ–°
        document.getElementById("romajiDisplay").innerHTML = currentDisplayedRomaji
            .split("")
            .map((letter, index) => `<span class="${index < currentIndex ? 'correct' : ''}">${letter.toUpperCase()}</span>`)
            .join("");

        //ã‚¯ãƒªã‚¢åˆ¤å®š
        if (currentIndex === currentDisplayedRomaji.length) {
            setRandomQuestion();
            currentDisplayedRomaji = ""; //æ¬¡ã®å•é¡Œã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
        }
    } else {
        mistakeCount++;
    }
}


  function showScoreScreen() {
    document.getElementById("wordContainer").style.display = "none";
    document.getElementById("scoreDisplay").style.display = "flex";

    setTimeout(() => {
      document.getElementById("scoreDisplay").style.display = "none";
      document.getElementById("romajiDisplay").style.display = "none";
      document.getElementById("handsContainer").style.display = "none";
      document.getElementById("keyboard").style.display = "none";
      calculateScore();  //ã‚¹ã‚³ã‚¢è¨ˆç®—
    }, 3000);
  }

  function showSeisekiScreen(accuracy, keySpeed, score, rank) {

    const rankTitles = {
      1: "ğŸ† ãƒã‚¹ã‚¿ãƒ¼ç´šã€€",
      2: "ğŸ¥‡ ã‚´ãƒ¼ãƒ«ãƒ‰ç´šã€€",
      3: "ğŸ¥ˆ ã‚·ãƒ«ãƒãƒ¼ç´šã€€",
      4: "ğŸ¥‰ ãƒ–ãƒ­ãƒ³ã‚ºç´šã€€",
      5: "âœ¨ ãƒ“ã‚®ãƒŠãƒ¼ç´šã€€"
    };

    document.getElementById("seisekiContent").innerHTML = `
    <table class="scoreTable">
      <tr><td>ğŸ¯ ã›ã„ã‹ãã•</td><td class="alignRight">${accuracy}%</td><td>ã¾ã¡ãŒãˆãªã„ã§ã†ã¦ãŸã‹ãªï¼Ÿ</td></tr>
      <tr><td>âš¡ ã‚¹ãƒ”ãƒ¼ãƒ‰</td><td class="alignRight">${keySpeed} å›/åˆ†</td><td>ã¯ã‚„ãã†ã¦ãŸã‹ãªï¼Ÿ</td></tr>
      <tr><td>ğŸ’¯ ã¦ã‚“ã™ã†</td><td class="alignRight">${score}ç‚¹</td><td>ã‚ãªãŸã®ã›ã„ã›ã</td></tr>
    </table>
    `;
    const rankTitle = rankTitles[rank]
    document.getElementById("nankyu").innerHTML = `
      <div class="rankDisplay rank-${rank}">
        ${rankTitle}
      </div>
    `;

    showSeisekiCharacter(rank);

    document.getElementById("seisekiDisplay").style.display = "flex";
    document.getElementById("seisekiContent").style.display = "flex";
  }

  function calculateScore() {    
    
    //çµŒéæ™‚é–“è¨ˆç®—
    let elapsedTime = (endTime - startTime) / 1000;
    elapsedTime = Math.max(1, elapsedTime);

    //æ­£ç¢ºæ€§ã‚’è¨ˆç®—
    let accuracy = (correctKeysPressed / totalKeysPressed) * 100;
    accuracy = isNaN(accuracy) ? 0 : parseFloat(accuracy.toFixed(2));

    //ã‚­ãƒ¼ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’è¨ˆç®— (1åˆ†ã‚ãŸã‚Šã®ã‚­ãƒ¼ã‚¿ã‚¤ãƒ—æ•°)
    let keySpeed = (correctKeysPressed / elapsedTime)* 60;
    keySpeed = isNaN(keySpeed) ? 0 : parseFloat(keySpeed.toFixed(2));

    //ãƒŸã‚¹ã‚¿ã‚¤ãƒ—ã®å½±éŸ¿ã‚’èª¿æ•´
    let adjustedMistake = mistakeCount * 70;

    //ã‚­ãƒ¼ã‚¹ãƒ”ãƒ¼ãƒ‰ã®å½±éŸ¿ã‚’è£œæ­£
    let adjustedSpeed = Math.pow(keySpeed, 0.9) * 18;

    //ã‚¹ã‚³ã‚¢ã®è¨ˆç®—
    let rawScore = Math.round(adjustedSpeed * (accuracy / 100) - adjustedMistake);

    //ã‚¹ã‚³ã‚¢ã®è£œæ­£
    let score = Math.max(0, Math.round(rawScore / 4));

    //å­¦å¹´ã«ã‚ˆã‚‹ã‚¹ã‚³ã‚¢è£œæ­£
    let rawGrade = 0;

    const gradeNumber = parseInt(selectedGrade.replace(/[^0-9]/g, ""), 10);

    if (gradeNumber == 1) {
        rawGrade = Math.round(score * 1.0);
    } else if (gradeNumber == 2) {
        rawGrade = Math.round(score * 0.8);
    } else if (gradeNumber == 3) {
        rawGrade = Math.round(score * 0.3);
    }

    //æ­£ç¢ºæ€§ãƒœãƒ¼ãƒŠã‚¹
    let seikakubonus = Math.max(0, Math.round(accuracy * 0.6));

    //è£œæ­£å¾Œã®ã‚¹ã‚³ã‚¢
    score += rawGrade;
    score += seikakubonus;


    //å–å¾—ç´šã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
    let rank;

    //ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸç´šæ•°
    if (score >= 500) {
        rank = 1;
    } else if (score >= 300) {
        rank = 2;
    } else if (score >= 150) {
        rank = 3;
    } else if (score >= 80) {
        rank = 4;
    } else {
        rank = 5;
    }

    showSeisekiScreen(accuracy, keySpeed, score, rank); // **æˆç¸¾ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º**
    

  }

  const seisekiMessages = {
    1: "ã™ã”ã„ï¼ãã¿ãŒã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒã‚¹ã‚¿ãƒ¼ï¼",
    2: "ãŠã¿ã”ã¨ï¼ï¼ã‚´ãƒ¼ãƒ«ãƒ‰ç´šï¼",
    3: "ã‚ˆããŒã‚“ã°ã£ãŸã­ï¼ã‚·ãƒ«ãƒãƒ¼ç´šï¼",
    4: "ã‚‚ã†ã™ã“ã—ï¼ãƒ–ãƒ­ãƒ³ã‚ºç´šï¼",
    5: "ã“ã‚Œã‹ã‚‰ã‚‚ã‚Œã‚“ã—ã‚…ã†ã—ã‚ˆã†ï¼"
  };

  function showSeisekiCharacter(rank) {
    const bubble = document.querySelector(".seiseki-bubble");
    bubble.textContent = seisekiMessages[rank]

    document.getElementById("seisekiimage").style.display = "flex";
  }

  //ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  document.getElementById("resetButton").addEventListener("click", function() {
    //è¡¨ç¤ºã‚’æ•´ç†
    document.getElementById("resetButton").style.display = "none";

    document.getElementById("gradeButtons").style.display = "grid";
    document.getElementById("select").style.display = "block";
    document.getElementById("keyboard").style.display = "flex";
    document.getElementById("fixedimage").style.display = "flex";
    document.getElementById("handsContainer").style.display = "block";
    
    document.getElementById("startMessage").style.display = "none";

    document.getElementById("gradeDisplay").style.display = "none";
    document.getElementById("wordContainer").style.display = "none";
    document.getElementById("romajiDisplay").style.display = "none";
    document.getElementById("result").style.display = "none";
    document.getElementById("seisekiDisplay").style.display = "none";
    document.getElementById("seisekiContent").style.display = "none";
    document.getElementById("seisekiimage").style.display = "none";
    document.getElementById("scoreDisplay").style.display = "none";

    //å¤‰æ•°ã®ãƒªã‚»ãƒƒãƒˆ
    selectedGrade = null;
    questions = [];
    remainingQuestions = [];
    questionCount = 0;
    currentIndex = 0;
    currentAnswerList = [];
    currentDisplayedRomaji = "";
    startTime = null;
    endTime = null;
    previousWordEndedWithN = 0;
    previousWordEndedWithN2 = 0;

    startTypingDemo();
  });

    </script>
</body>
</html>
